/*\
title: $:/plugins/tobibeer/sparkl/widget.js
type: application/javascript
module-type: widget

The sparkl widget renders simple inline sparkline diagrams

@preserve
\*/
(function(){"use strict";var t=require("$:/core/modules/widgets/widget.js").widget,e=function(t,e){this.initialise(t,e)};e.prototype=new t;e.prototype.render=function(t,e){this.parentDomNode=t;this.nextSibling=e;this.computeAttributes();this.execute();if($tw.node){return}var i=this,s,l,r,a,n,d,u,o,h,p,f,g,m,c,b,k,w,x=[],T,y,A=[],$,N,v,C,S=i.wiki.getTiddlerText("$:/plugins/tobibeer/sparkl/defaults/default");if(!i.values||!i.titles&&i.filter){return}if(i.titles){$tw.utils.each(i.wiki.filterTiddlers(i.titles,i),function(t){x.push(t)})}$tw.utils.each(i.filter?x:i.values.split(" "),function(t){if(i.filter){t=i.wiki.filterTiddlers(i.values.replace(/%title%/gm,t),i);if(!t.length||isNaN(parseFloat(t[0],10))){t=i.default||S}else{t=t[0]}}t=parseFloat(t,10);if(isNaN(t)){t=0}if(c===undefined){c=t;g=t}if(g<t){g=t}if(c>t){c=t}A.push(t)});if(!A.length){return}p=i.link||i.filter?i.link===""?i.wiki.getTiddlerText("$:/plugins/tobibeer/sparkl/defaults/link"):["false","no"].indexOf(i.link)>=0?0:i.link:0;m=i.max?i.max:i.wiki.getTiddlerText("$:/plugins/tobibeer/sparkl/defaults/max");if(m!=="max"){g=parseInt(m,10)}b=i.min?i.min:i.wiki.getTiddlerText("$:/plugins/tobibeer/sparkl/defaults/min");if(b!=="min"){if(b.charAt(b.length-1)==="%"){c=c-(g-c)*parseInt(b.substr(0,b.length-1),10)/100}else{c=parseInt(b,10)}}k=parseInt(i.segments,10);if(isNaN(k)){k=parseInt(i.wiki.getTiddlerText("$:/plugins/tobibeer/sparkl/defaults/segments"),10)||20}f=i.margin||i.wiki.getTiddlerText("$:/plugins/tobibeer/sparkl/defaults/margin")||0;C=i.width||i.wiki.getTiddlerText("$:/plugins/tobibeer/sparkl/defaults/width")||"3px";switch(A.length){case 1:C="1em";break;case 2:C="0.5em";break;case 3:C="0.33em";break}l=document.createElement("span");l.textContent=String.fromCharCode(160);a=i.classes?i.classes.split(" "):[];a.push("tc-sparkl");s=i.as||i.wiki.getTiddlerText("$:/plugins/tobibeer/sparkl/defaults/as");if(s==="dots"){a.push("tc-sparkl-dots");d=parseFloat(i.dotSize||i.wiki.getTiddlerText("$:/plugins/tobibeer/sparkl/defaults/dot-size"),10);if(!d||isNaN(d)){d=2}}l.className=a.join(" ");t.insertBefore(l,e);for(T=0;T<A.length;T++){w=x[T];if(p){v=document.createElement("a");w=(p||"").indexOf("%title%")<0?w:i.wiki.filterTiddlers(p.replace(/%title%/gm,x[T]),i)[0]||w;v.setAttribute("href","#"+w);v.style.cursor="pointer"}else{v=document.createElement("span")}v.className="tc-sparkl-bar";v.title=w?w+" ("+A[T]+")":A[T];r=document.createElement("b");r.style.width=C;y=g===c?0:1-(A[T]-c)/(g-c);y=Math.max(0,y);v.appendChild(r);l.appendChild(v);h=window.getComputedStyle(v,null).getPropertyValue("height");h=parseFloat(h.substr(0,h.length-2),10);h=s==="dots"?h-3*d/2:h;y=h*Math.round(k*y)/k;r.style.borderTopWidth=y+"px";r.style.marginLeft=f;if(s==="dots"){u=d+"px";o=d/2+"px";n=document.createElement("i");n.setAttribute("class","tc-sparkl-dot tc-sparkl-dot-"+i.dots);n.style.width=u;n.style.height=u;n.style.top=o;n.style.borderRadius=o;n.style.MozBorderRadius=o;n.style.WebkitBorderRadius=o;r.appendChild(n);$=window.getComputedStyle(r,null).getPropertyValue("width");N=window.getComputedStyle(n,null).getPropertyValue("width");$=parseFloat($.substr(0,$.length-2),10);N=parseFloat(N.substr(0,N.length-2),10);n.style.left=($-N)/2+"px"}}};e.prototype.execute=function(){this.values=this.getAttribute("values");this.titles=this.getAttribute("titles");this.default=this.getAttribute("default");this.classes=this.getAttribute("class");this.min=this.getAttribute("min");this.max=this.getAttribute("max");this.segments=this.getAttribute("segments");this.width=this.getAttribute("width");this.margin=this.getAttribute("margin");this.link=(this.getAttribute("link")||"").toLowerCase();this.as=this.getAttribute("as");if(this.as&&this.as.indexOf("dots")===0){this.dots=this.as.substr(5)||"";this.as="dots";if(!this.dots||["circles"].indexOf(this.dots)<0){this.dots="circles"}}this.dotSize=this.getAttribute("dot-size");if(this.values.indexOf("%title%")>=0){this.filter=1}};e.prototype.refresh=function(){var t=this.computeAttributes();if(t.values||t.titles||t["class"]||t.default||t.min||t.max||t.width||t.margin||t.segments||t.link||t.as||t.dotSize){this.refreshSelf();return true}else{return false}};exports.sparkl=e})();